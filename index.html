<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ—ãƒ¬ã‚¤ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ v16ï¼ˆFirebaseãƒ­ãƒ“ãƒ¼åŒæœŸï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --sidebar-w: 300px; --preview-w: 300px; --header-h: 80px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif; margin:0; background:#eee; overflow:hidden; }
    h1 { background:#444; color:#fff; padding:1em; text-align:center; margin:0; height:var(--header-h); box-sizing:border-box; display:flex; align-items:center; justify-content:center; gap:1rem; position:relative; }
    #session-indicator { position:absolute; right:12px; top:50%; transform:translateY(-50%); color:#ddd; font-size:12px; opacity:.9; }
    #upload-area { padding:16px; text-align:center; background:#fff; cursor:pointer; border-bottom:2px solid #ccc; user-select:none; }
    #file-input { display:none; }
    #sidebar { width:var(--sidebar-w); height:calc(100vh - var(--header-h) - 120px); float:left; background:#fff; border-right:2px solid #aaa; box-shadow:2px 0 5px rgba(0,0,0,.2); padding:10px; box-sizing:border-box; }
    #sidebar h2 { font-size:14px; text-align:center; margin:20px 0 10px; }
    #sidebar button { width:100%; margin-bottom:10px; padding:10px; font-size:14px; cursor:pointer; }
    #field-size-options { display:none; margin-top:5px; text-align:center; }
    #field-size-options button { width:30%; margin:5px 2%; padding:5px; font-size:13px; }
    #container { width:calc(100% - var(--sidebar-w) - var(--preview-w)); height:calc(100vh - var(--header-h) - 120px); overflow:hidden; position:relative; float:left; background:#f7f7f7; }
    #field { position:absolute; transform-origin:0 0; background:none; }
    .player-area { position:absolute; width:50%; height:50%; border:5px dashed #666; box-sizing:border-box; }
    .player-1{ top:0; left:0; } .player-2{ top:0; left:50%; } .player-3{ top:50%; left:0; } .player-4{ top:50%; left:50%; }
    .play-area{ position:relative; left:0; width:100%; height:66.66%; display:flex; flex-direction:row; z-index:0; }
    .deck-area{ width:33.33%; background:#f90; } .main-play-area{ width:66.66%; background:#2d8; }
    .hand-area{ position:relative; bottom:0; left:0; width:100%; height:33.33%; background:#228be6; z-index:0; }
    .card{ width:120px; height:160px; position:absolute; border:2px solid #333; border-radius:10px; box-shadow:2px 2px 5px rgba(0,0,0,.4); background:#fff; cursor:grab; user-select:none; transition:border .2s; z-index:1; }
    .card img{ width:100%; height:100%; border-radius:10px; object-fit:cover; pointer-events:none; user-select:none; }
    .card.selected{ border:3px solid red; }
    #preview{ width:var(--preview-w); height:calc(100vh - var(--header-h) - 120px); float:right; background:#fff; border-left:2px solid #aaa; box-shadow:-2px 0 5px rgba(0,0,0,.2); padding:10px; box-sizing:border-box; }
    #preview h2{ font-size:14px; margin:0 0 10px; text-align:center; } #preview-img{ width:100%; height:auto; border-radius:10px; display:none; }
    #lobby{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .lobby-card{ width:min(560px, 92vw); background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:20px 20px 16px; box-sizing:border-box; }
    .lobby-title{ font-size:20px; font-weight:700; margin:4px 0 12px; text-align:center; }
    .lobby-desc{ font-size:13px; color:#444; text-align:center; }
    .lobby-field{ margin:16px 0 8px; }
    .lobby-label{ display:block; font-size:12px; color:#555; margin-bottom:6px; }
    .lobby-row{ display:flex; gap:8px; }
    #room-id{ flex:1; padding:10px 12px; font-size:16px; border:1px solid #bbb; border-radius:10px; }
    .seat-grid{ display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; }
    .seat-btn{ padding:12px 0; border-radius:10px; border:1px solid #bbb; background:#fafafa; cursor:pointer; font-weight:600; position:relative; }
    .seat-btn.active{ outline:3px solid #0a7; background:#e9fff7; }
    .seat-btn[disabled]{ background:#eee; color:#888; border-color:#ddd; cursor:not-allowed; }
    .seat-note{ position:absolute; inset:auto 8px 6px auto; font-size:10px; color:#666; }
    .lobby-actions{ display:flex; gap:8px; margin-top:14px; }
    .btn{ flex:1; padding:12px 10px; border-radius:10px; border:0; background:#0a7; color:#fff; font-weight:700; cursor:pointer; opacity:.95; }
    .btn:disabled{ background:#9ab; cursor:not-allowed; opacity:.7; }
    .btn.secondary{ background:#eee; color:#333; border:1px solid #ccc; }
    #spacer{ height:40px; clear:both; }
  </style>
</head>
<body>
  <h1>
    ç”»åƒã§éŠã¹ã‚‹ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ã‚²ãƒ¼ãƒ ï¼ˆ4äººç”¨ï¼‰
    <span id="session-indicator">ROOM: - / PLAYER: -</span>
  </h1>

  <!-- ãƒ­ãƒ“ãƒ¼ -->
  <div id="lobby" aria-modal="true" role="dialog">
    <div class="lobby-card">
      <div class="lobby-title">ãƒ—ãƒ¬ã‚¤ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã‚ˆã†ã“ã</div>
      <div class="lobby-desc">ãƒ«ãƒ¼ãƒ ç•ªå·ã‚’å…¥åŠ›ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆæœ€å¤§4äººï¼‰<br>åŒã˜ãƒ«ãƒ¼ãƒ ã§ã¯ä»–ã®äººãŒé¸æŠæ¸ˆã¿ã®åº§å¸­ã¯é¸ã¹ã¾ã›ã‚“ã€‚</div>

      <div class="lobby-field">
        <label class="lobby-label" for="room-id">ãƒ«ãƒ¼ãƒ ç•ªå·ï¼ˆåŠè§’è‹±æ•°ãƒ»ãƒã‚¤ãƒ•ãƒ³å¯ï¼‰</label>
        <div class="lobby-row">
          <input id="room-id" type="text" placeholder="ä¾‹: 1234 / room-Alpha" autocomplete="off" />
        </div>
      </div>

      <div class="lobby-field">
        <span class="lobby-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ</span>
        <div class="seat-grid">
          <button class="seat-btn" data-seat="1">P1 <span class="seat-note"></span></button>
          <button class="seat-btn" data-seat="2">P2 <span class="seat-note"></span></button>
          <button class="seat-btn" data-seat="3">P3 <span class="seat-note"></span></button>
          <button class="seat-btn" data-seat="4">P4 <span class="seat-note"></span></button>
        </div>
      </div>

      <div class="lobby-actions">
        <button id="start-btn" class="btn" disabled>é–‹å§‹</button>
        <button id="clear-btn" class="btn secondary">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
  </div>

  <div id="upload-area">
    ğŸ“¥ ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ or ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§è¿½åŠ 
    <input type="file" id="file-input" multiple accept="image/*" />
  </div>

  <div id="sidebar">
    <h2>æ“ä½œãƒ‘ãƒãƒ«</h2>
    <button onclick="faceDownAll()">ğŸ‚  è£è¿”ã™</button>
    <button onclick="faceUpAll()">ğŸ‚¡ è¡¨ã«ã™ã‚‹</button>
    <button onclick="shuffleDecks()">ğŸŒ€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆP1ã®ã¿ï¼‰</button>
    <button onclick="alignDecks()">ğŸ“ æ•´åˆ—</button>

    <button onclick="toggleFieldSizeOptions()">ğŸ–¼ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´</button>
    <div id="field-size-options">
      <button onclick="setFieldSize('small')">å°</button>
      <button onclick="setFieldSize('medium')">ä¸­</button>
      <button onclick="setFieldSize('large')">å¤§</button>
    </div>

    <h2>å…¨ã‚«ãƒ¼ãƒ‰ã‚’ç§»å‹•</h2>
    <button onclick="shiftAllCards(0, -160)">â¬† ä¸Šã«ãšã‚‰ã™</button>
    <button onclick="shiftAllCards(0, 160)">â¬‡ ä¸‹ã«ãšã‚‰ã™</button>
    <button onclick="shiftAllCards(-120, 0)">â¬… å·¦ã«ãšã‚‰ã™</button>
    <button onclick="shiftAllCards(120, 0)">â¡ å³ã«ãšã‚‰ã™</button>
  </div>

  <div id="container">
    <div id="field">
      <div class="player-area player-1">
        <div class="play-area">
          <div class="deck-area"></div>
          <div class="main-play-area"></div>
        </div>
        <div class="hand-area"></div>
      </div>
      <div class="player-area player-2">
        <div class="play-area">
          <div class="deck-area"></div>
          <div class="main-play-area"></div>
        </div>
        <div class="hand-area"></div>
      </div>
      <div class="player-area player-3">
        <div class="play-area">
          <div class="deck-area"></div>
          <div class="main-play-area"></div>
        </div>
        <div class="hand-area"></div>
      </div>
      <div class="player-area player-4">
        <div class="play-area">
          <div class="deck-area"></div>
          <div class="main-play-area"></div>
        </div>
        <div class="hand-area"></div>
      </div>
    </div>
  </div>

  <div id="preview">
    <h2>é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰</h2>
    <img id="preview-img" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ" />
  </div>

  <div id="spacer"></div>

  <!-- Firebase v10 CDNï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å›ºå®šæ¨å¥¨ï¼‰ -->
  <script type="module">
    /* ---------------------- Firebase åˆæœŸåŒ– ---------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // TODO: ã‚ãªãŸã® Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã§ç½®ãæ›ãˆ
    const firebaseConfig = {
      apiKey: "AIzaSyCy-r6L1NgyHcqvsfpkyNPDJq9uMvv2CMM",
      authDomain: "cardgame-f484c.firebaseapp.com",
      projectId: "cardgame-f484c",
      storageBucket: "cardgame-f484c.firebasestorage.app",
      messagingSenderId: "248859224605",
      appId: "1:248859224605:web:1320093856bc1861c174f4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ---------------------- ãƒ­ãƒ“ãƒ¼çŠ¶æ…‹åŒæœŸã®è€ƒãˆæ–¹ ----------------------
      - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹æˆï¼ˆæœ€å°å½¢ï¼‰
         rooms/{roomId}
           seats/{seatId: "1"|"2"|"3"|"4"}
             { claimedBy, claimedAt, heartbeatAt }

      - åº§å¸­ç¢ºä¿ã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ã€Œç©ºå¸­ã®ã¿ç¢ºä¿ã€
      - é€€å®¤/ã‚¿ãƒ–é–‰ã˜æ™‚ã¯ best-effort ã§ seat ã‚’é–‹æ”¾
      - ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã§ç”Ÿå­˜æ¤œçŸ¥ï¼ˆãƒ‡ãƒ•ã‚© 10ç§’ï¼‰ã€‚60ç§’ä»¥ä¸Šæ›´æ–°ãŒç„¡ã„ seat ã¯é™³è…åŒ–ã¨ã—ã¦å†å–å¾—å¯ï¼ˆãƒ«ãƒ¼ãƒ«ã¨å®Ÿè£…ã§æ‹…ä¿ï¼‰
    --------------------------------------------------------------- */

    /* ---------------------- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† ---------------------- */
    let CURRENT_ROOM = null; // æ–‡å­—åˆ—
    let CURRENT_PLAYER = null; // 1..4 ã®æ•°å€¤
    const CLIENT_ID_KEY = 'playaround_client_id_v1';
    const clientId = getOrCreateClientId();

    function getOrCreateClientId(){
      const k = localStorage.getItem(CLIENT_ID_KEY);
      if(k) return k;
      const v = crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random());
      localStorage.setItem(CLIENT_ID_KEY, v);
      return v;
    }

    /* ---------------------- ãƒ­ãƒ“ãƒ¼UIå‚ç…§ ---------------------- */
    const lobby = document.getElementById('lobby');
    const roomInput = document.getElementById('room-id');
    const startBtn = document.getElementById('start-btn');
    const clearBtn = document.getElementById('clear-btn');
    const seatButtons = Array.from(document.querySelectorAll('.seat-btn'));
    const sessionIndicator = document.getElementById('session-indicator');

    let unsubscribeSeats = null;
    let heartbeatTimer = null;

    // ãƒ«ãƒ¼ãƒ å…¥åŠ›ã§åº§å¸­ä¸€è¦§ã‚’è³¼èª­
    roomInput.addEventListener('input', () => {
      const room = roomInput.value.trim();
      detachSeatsListener();
      if(!room) { renderSeatAvailability({}); validateLobby(); return; }
      attachSeatsListener(room);
    });

    function attachSeatsListener(roomId){
      const seatsPath = doc(db, `rooms/${roomId}`);
      // éƒ¨å±‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç„¡ã„å ´åˆã§ã‚‚åº§å¸­ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã‚€ãŸã‚ã€å€‹åˆ¥ onSnapshot ã¯ seat ã”ã¨ã«è¡Œã†
      const seatDocs = [1,2,3,4].map(n => doc(db, `rooms/${roomId}/seats/${n}`));
      const unsubs = seatDocs.map((ref, idx) => onSnapshot(ref, snap => {
        const seatMap = currentSeatMap;
        seatMap[idx+1] = snap.exists() ? snap.data() : null;
        renderSeatAvailability(seatMap);
      }));
      unsubscribeSeats = () => unsubs.forEach(fn => fn());
    }

    function detachSeatsListener(){
      if(unsubscribeSeats){ unsubscribeSeats(); unsubscribeSeats = null; }
    }

    // ç¾åœ¨ã®åº§å¸­çŠ¶æ…‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const currentSeatMap = { 1:null, 2:null, 3:null, 4:null };

    function isSeatStale(data){
      if(!data || !data.heartbeatAt) return true; // æƒ…å ±ãªã—ã¯ç©ºãã¨ã¿ãªã™
      const now = Date.now();
      const hb = data.heartbeatAt?.toMillis ? data.heartbeatAt.toMillis() : (typeof data.heartbeatAt === 'number' ? data.heartbeatAt : 0);
      return (now - hb) > 60000; // 60ç§’ä»¥ä¸Šæ›´æ–°ãŒç„¡ã‘ã‚Œã°é™³è…åŒ–
    }

    function renderSeatAvailability(seatMap){
      seatButtons.forEach(btn => {
        const seat = parseInt(btn.dataset.seat, 10);
        const note = btn.querySelector('.seat-note');
        const data = seatMap[seat];
        const taken = data && !isSeatStale(data) && data.claimedBy && data.claimedBy !== clientId;
        const mine = data && !isSeatStale(data) && data.claimedBy === clientId;
        btn.disabled = taken; // ä»–äººãŒå æœ‰ã—ã¦ã„ã‚‹å ´åˆã®ã¿ç„¡åŠ¹åŒ–
        note.textContent = taken ? 'ä½¿ç”¨ä¸­' : (mine ? 'ã‚ãªãŸ' : 'ç©ºå¸­');
        btn.classList.toggle('active', CURRENT_PLAYER === seat);
      });
      validateLobby();
    }

    function validateLobby(){
      const roomOk = !!roomInput.value.trim();
      const seatOk = !!CURRENT_PLAYER;
      startBtn.disabled = !(roomOk && seatOk);
    }

    seatButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const seat = parseInt(btn.dataset.seat, 10);
        const roomId = roomInput.value.trim();
        if(!roomId) { CURRENT_PLAYER = null; validateLobby(); return; }
        const ok = await claimSeat(roomId, seat);
        if(ok){ CURRENT_PLAYER = seat; } else { CURRENT_PLAYER = null; alert(`P${seat} ã¯ä½¿ç”¨ä¸­ã§ã™ã€‚`); }
        validateLobby();
      });
    });

    clearBtn.addEventListener('click', () => {
      roomInput.value = '';
      CURRENT_PLAYER = null;
      renderSeatAvailability({1:null,2:null,3:null,4:null});
      detachSeatsListener();
      validateLobby();
      roomInput.focus();
    });

    startBtn.addEventListener('click', async () => {
      const room = roomInput.value.trim();
      if(!room || !CURRENT_PLAYER) return;
      // å¿µã®ãŸã‚ã‚‚ã†ä¸€åº¦ç¢ºä¿ã‚’è©¦ã¿ã‚‹ï¼ˆç«¶åˆå¯¾ç­–ï¼‰
      const ok = await claimSeat(room, CURRENT_PLAYER);
      if(!ok){ alert('é–‹å§‹ç›´å‰ã«åº§å¸­ãŒåŸ‹ã¾ã‚Šã¾ã—ãŸã€‚åˆ¥ã®åº§å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
      startSession(room, CURRENT_PLAYER);
    });

    async function claimSeat(roomId, seat){
      const seatRef = doc(db, `rooms/${roomId}/seats/${seat}`);
      try {
        const success = await runTransaction(db, async (tx) => {
          const snap = await tx.get(seatRef);
          if(!snap.exists()){
            tx.set(seatRef, { claimedBy: clientId, claimedAt: serverTimestamp(), heartbeatAt: serverTimestamp() });
            return true;
          }
          const data = snap.data();
          const stale = isSeatStale(data);
          if(!data.claimedBy || stale || data.claimedBy === clientId){
            tx.set(seatRef, { claimedBy: clientId, claimedAt: serverTimestamp(), heartbeatAt: serverTimestamp() });
            return true;
          }
          return false;
        });
        return success;
      } catch(e){
        console.error('claimSeat error', e);
        return false;
      }
    }

    async function releaseSeat(roomId, seat){
      if(!roomId || !seat) return;
      try { await deleteDoc(doc(db, `rooms/${roomId}/seats/${seat}`)); } catch(e){ console.warn('releaseSeat error', e); }
    }

    function startHeartbeat(roomId, seat){
      stopHeartbeat();
      heartbeatTimer = setInterval(async () => {
        try {
          await setDoc(doc(db, `rooms/${roomId}/seats/${seat}`), { claimedBy: clientId, heartbeatAt: serverTimestamp() }, { merge:true });
        } catch(e){ console.warn('heartbeat failed', e); }
      }, 10000); // 10ç§’
    }

    function stopHeartbeat(){ if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer = null; } }

    function startSession(roomId, playerId){
      CURRENT_ROOM = roomId; CURRENT_PLAYER = playerId;
      sessionIndicator.textContent = `ROOM: ${CURRENT_ROOM} / PLAYER: P${CURRENT_PLAYER}`;
      lobby.style.display = 'none';
      startHeartbeat(roomId, playerId);
      window.addEventListener('beforeunload', () => { stopHeartbeat(); releaseSeat(roomId, playerId); });
      // æ—¢å­˜æ©Ÿèƒ½ã®èµ·å‹•
      initializePlayField();
    }

    /* ---------------------- ã“ã“ã‹ã‚‰å¾“æ¥ã® ver14 æ©Ÿèƒ½ ---------------------- */
    const uploadArea = document.getElementById("upload-area");
    const fileInput = document.getElementById("file-input");
    const field = document.getElementById("field");
    const previewImg = document.getElementById("preview-img");
    const fieldSizeOptions = document.getElementById("field-size-options");

    let zoom = 1, panOffsetX = 0, panOffsetY = 0, selectedCard = null;

    function initializePlayField(){ setFieldSize('small'); bindUploadHandlers(); bindPanZoomHandlers(); }

    function bindUploadHandlers(){
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", e => { e.preventDefault(); uploadArea.style.backgroundColor = "#eef"; });
      uploadArea.addEventListener("dragleave", () => { uploadArea.style.backgroundColor = "#fff"; });
      uploadArea.addEventListener("drop", e => { e.preventDefault(); uploadArea.style.backgroundColor = "#fff"; handleFiles(e.dataTransfer.files); });
      fileInput.addEventListener("change", e => handleFiles(e.target.files));
    }

    function handleFiles(files){
      [...files].forEach(file => {
        if(!file.type.startsWith("image/")) return;
        const reader = new FileReader();
        reader.onload = e => createCard(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    function createCard(imageSrc){
      const card = document.createElement("div");
      card.className = "card";
      card.style.left = `${Math.random() * 500}px`;
      card.style.top = `${Math.random() * 500}px`;
      const img = document.createElement("img");
      img.src = imageSrc; card.appendChild(img); field.appendChild(card);
      makeDraggable(card);
      card.addEventListener("contextmenu", e => { e.preventDefault(); const up = img.style.display !== "none"; img.style.display = up?"none":"block"; card.style.backgroundColor = up?"#000":"#fff"; });
      card.addEventListener("click", e => { e.stopPropagation(); if(selectedCard) selectedCard.classList.remove("selected"); card.classList.add("selected"); selectedCard = card; if(img && img.style.display !== "none"){ previewImg.src = img.src; previewImg.style.display = "block"; } else { previewImg.src = ""; previewImg.style.display = "none"; } });
    }

    function makeDraggable(card){
      let offsetX=0, offsetY=0, isDragging=false;
      card.addEventListener("mousedown", e => {
        if(e.button!==0) return;
        const rect = field.getBoundingClientRect();
        const mouseX = (e.clientX - rect.left - panOffsetX) / zoom;
        const mouseY = (e.clientY - rect.top - panOffsetY) / zoom;
        offsetX = mouseX - parseFloat(card.style.left);
        offsetY = mouseY - parseFloat(card.style.top);
        isDragging = true; card.style.cursor = "grabbing"; card.style.zIndex = getMaxZIndex()+1;
        const onMove = e => { if(!isDragging) return; const x=(e.clientX - rect.left - panOffsetX)/zoom; const y=(e.clientY - rect.top - panOffsetY)/zoom; card.style.left = `${x - offsetX}px`; card.style.top = `${y - offsetY}px`; };
        const onUp = () => { isDragging = false; card.style.cursor = "grab"; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); };
        document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp);
      });
    }

    function getMaxZIndex(){ let max=0; document.querySelectorAll(".card").forEach(c=>{ const z=parseInt(c.style.zIndex)||0; if(z>max) max=z; }); return max; }
    function faceDownAll(){ document.querySelectorAll(".card").forEach(card=>{ const img=card.querySelector("img"); if(img) img.style.display="none"; card.style.backgroundColor="#000"; }); previewImg.src=""; previewImg.style.display="none"; }
    function faceUpAll(){ document.querySelectorAll(".card").forEach(card=>{ const img=card.querySelector("img"); if(img) img.style.display="block"; card.style.backgroundColor="#fff"; }); }

    function shuffleDecks(){
      const cards = Array.from(document.querySelectorAll(".card"));
      const player1DeckArea = document.querySelector(".player-1 .deck-area");
      if(!player1DeckArea) return;
      const rect = player1DeckArea.getBoundingClientRect();
      const fieldRect = field.getBoundingClientRect();
      const minX = (rect.left - fieldRect.left + field.scrollLeft) / zoom;
      const minY = (rect.top - fieldRect.top + field.scrollTop) / zoom;
      const maxX = minX + rect.width / zoom;
      const maxY = minY + rect.height / zoom;
      const deckCards = cards.filter(card => { const left=parseFloat(card.style.left)||0; const top=parseFloat(card.style.top)||0; return left>=minX && left<=maxX && top>=minY && top<=maxY; });
      const shuffled = deckCards.sort(()=>Math.random()-0.5);
      const baseX = minX + 10; const baseY = minY + 10;
      shuffled.forEach((card,i)=>{ card.style.left=`${baseX}px`; card.style.top=`${baseY}px`; card.style.zIndex=i+1; });
    }

    function alignDecks(){
      const cards = Array.from(document.querySelectorAll(".card"));
      let x=20,y=20; const maxW = window.innerWidth - (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w')) + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--preview-w'))) - 40;
      cards.forEach(card=>{ card.style.left=`${x}px`; card.style.top=`${y}px`; card.style.zIndex=1; x+=140; if(x>maxW){ x=20; y+=180; } });
    }

    function toggleFieldSizeOptions(){ const el=document.getElementById("field-size-options"); el.style.display = el.style.display==="none"?"block":"none"; }
    function setFieldSize(size){ const sizes={ small:[3000,1500], medium:[5000,2500], large:[10000,5000] }; const [w,h]=sizes[size]||sizes.small; field.style.width=`${w}px`; field.style.height=`${h}px`; field.style.transform=`translate(${panOffsetX}px, ${panOffsetY}px) scale(${zoom})`; }
    function shiftAllCards(dx,dy){ document.querySelectorAll(".card").forEach(card=>{ const left=parseFloat(card.style.left)||0; const top=parseFloat(card.style.top)||0; card.style.left=`${left+dx}px`; card.style.top=`${top+dy}px`; }); }

    function bindPanZoomHandlers(){
      field.addEventListener("wheel", e => { if(e.ctrlKey) return; e.preventDefault(); const rect=field.getBoundingClientRect(); const cx=e.clientX-rect.left; const cy=e.clientY-rect.top; const scale=0.1; const old=zoom; zoom += e.deltaY<0?scale:-scale; zoom = Math.max(0.3, Math.min(zoom, 3)); const sx=(cx - panOffsetX)/old; const sy=(cy - panOffsetY)/old; panOffsetX = cx - sx*zoom; panOffsetY = cy - sy*zoom; field.style.transform=`translate(${panOffsetX}px, ${panOffsetY}px) scale(${zoom})`; }, {passive:false});
      field.addEventListener("mousedown", e => { if(e.target.closest(".card")) return; let panning=true; let sx=e.clientX, sy=e.clientY; const onMove=e2=>{ if(!panning) return; const dx=e2.clientX-sx; const dy=e2.clientY-sy; panOffsetX+=dx; panOffsetY+=dy; sx=e2.clientX; sy=e2.clientY; field.style.transform=`translate(${panOffsetX}px, ${panOffsetY}px) scale(${zoom})`; }; const onUp=()=>{ panning=false; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }; document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp); });
      field.addEventListener("click", () => { if(selectedCard){ selectedCard.classList.remove("selected"); selectedCard=null; previewImg.src=""; previewImg.style.display="none"; } });
    }

    // è‡ªå‹•èµ·å‹•ã¯ã—ãªã„ï¼šãƒ­ãƒ“ãƒ¼ã‹ã‚‰é–‹å§‹
  </script>
</body>
</html>
