<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ—ãƒ¬ã‚¤ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ v19ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ç´ã¥ã‘ + æ“ä½œãƒ­ãƒƒã‚¯ + è¤‡è£½é˜²æ­¢ + ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚ªãƒ¼ãƒŠãƒ¼è¡¨ç¤ºï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --sidebar-w: 300px; --preview-w: 300px; --header-h: 80px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif; margin:0; background:#eee; overflow:hidden; }
    h1 { background:#444; color:#fff; padding:1em; text-align:center; margin:0; height:var(--header-h); box-sizing:border-box; display:flex; align-items:center; justify-content:center; gap:1rem; position:relative; }
    #session-indicator { position:absolute; right:12px; top:50%; transform:translateY(-50%); color:#ddd; font-size:12px; opacity:.9; }
    #upload-area { padding:16px; text-align:center; background:#fff; cursor:pointer; border-bottom:2px solid #ccc; user-select:none; }
    #file-input { display:none; }
    #sidebar { width:var(--sidebar-w); height:calc(100vh - var(--header-h) - 120px); float:left; background:#fff; border-right:2px solid #aaa; box-shadow:2px 0 5px rgba(0,0,0,.2); padding:10px; box-sizing:border-box; }
    #sidebar h2 { font-size:14px; text-align:center; margin:20px 0 10px; }
    #sidebar button { width:100%; margin-bottom:10px; padding:10px; font-size:14px; cursor:pointer; }
    #field-size-options { display:none; margin-top:5px; text-align:center; }
    #field-size-options button { width:30%; margin:5px 2%; padding:5px; font-size:13px; }
    #container { width:calc(100% - var(--sidebar-w) - var(--preview-w)); height:calc(100vh - var(--header-h) - 120px); overflow:hidden; position:relative; float:left; background:#f7f7f7; }
    #field { position:absolute; transform-origin:0 0; background:none; }
    .player-area { position:absolute; width:50%; height:50%; border:5px dashed #666; box-sizing:border-box; }
    .player-1{ top:0; left:0; } .player-2{ top:0; left:50%; } .player-3{ top:50%; left:0; } .player-4{ top:50%; left:50%; }
    .play-area{ position:relative; left:0; width:100%; height:66.66%; display:flex; flex-direction: row-reverse; z-index:0; }
    .deck-area{ width:33.33%; background:#f90; } .main-play-area{ width:66.66%; background:#2d8; }
    .hand-area{ position:relative; bottom:0; left:0; width:100%; height:33.33%; background:#228be6; z-index:0; }
    .card{ width:120px; height:160px; position:absolute; border:2px solid #333; border-radius:10px; box-shadow:2px 2px 5px rgba(0,0,0,.4); background:#fff; cursor:grab; user-select:none; transition:border .2s; z-index:1; }
    .card[data-owner="other"]{ cursor:not-allowed; opacity:.95; }
    .card img{ width:100%; height:100%; border-radius:10px; object-fit:cover; pointer-events:none; user-select:none; }
    .card.selected{ border:3px solid red; }
    #preview{ width:var(--preview-w); height:calc(100vh - var(--header-h) - 120px); float:right; background:#fff; border-left:2px solid #aaa; box-shadow:-2px 0 5px rgba(0,0,0,.2); padding:10px; box-sizing:border-box; }
    #preview h2{ font-size:14px; margin:0 0 10px; text-align:center; } #preview-img{ width:100%; height:auto; border-radius:10px; display:none; }

    #lobby{ position:fixed; inset:0; background:rgba(0,0,0,.58); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .lobby-card{ width:min(820px, 96vw); background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:18px; box-sizing:border-box; }
    .lobby-grid{ display:grid; grid-template-columns: 1.15fr 1fr; gap:14px; }
    .lobby-title{ font-size:20px; font-weight:700; margin:4px 0 12px; text-align:center; }
    .lobby-section{ border:1px solid #e3e3e3; border-radius:12px; padding:12px; }
    .lobby-label{ display:block; font-size:12px; color:#555; margin-bottom:6px; }
    .row{ display:flex; gap:8px; align-items:center; }
    .field{ flex:1; padding:10px 12px; font-size:16px; border:1px solid #bbb; border-radius:10px; }
    .btn{ padding:10px 12px; border-radius:10px; border:0; background:#0a7; color:#fff; font-weight:700; cursor:pointer; opacity:.95; }
    .btn:disabled{ background:#9ab; cursor:not-allowed; opacity:.7; }
    .btn.secondary{ background:#eee; color:#333; border:1px solid #ccc; }
    .seat-grid{ display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-top:8px; }
    .seat-btn{ padding:12px 0; border-radius:10px; border:1px solid #bbb; background:#fafafa; cursor:pointer; font-weight:600; position:relative; }
    .seat-btn.active{ outline:3px solid #0a7; background:#e9fff7; }
    .seat-btn[disabled]{ background:#eee; color:#888; border-color:#ddd; cursor:not-allowed; }
    .seat-note{ position:absolute; inset:auto 8px 6px auto; font-size:10px; color:#666; }
    .room-list{ max-height:320px; overflow:auto; border:1px solid #e5e5e5; border-radius:10px; }
    .room-item{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #f0f0f0; }
    .room-item:last-child{ border-bottom:0; }
    .room-id{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; }
    #spacer{ height:40px; clear:both; }
    
    .player-label {
    position: absolute;
    top: 6px;
    left: 6px;
    font-size: 22px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.95);
    background: rgba(0, 0, 0, 0.4);
    padding: 2px 8px;
    border-radius: 4px;
    pointer-events: none; /* ã‚«ãƒ¼ãƒ‰æ“ä½œã«å¹²æ¸‰ã—ãªã„ */
    z-index: 10; /* â˜…ã“ã‚Œã‚’è¿½åŠ ï¼šä»–è¦ç´ ã‚ˆã‚Šå‰ã«å‡ºã™ */
    }
    
  .zone-label {
    position: absolute;
    right: 4px;
    bottom: 4px;
    font-size: 12px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.95);
    background: rgba(0, 0, 0, 0.4);
    padding: 1px 6px;
    border-radius: 4px;
    pointer-events: none;
    z-index: 5;
  }

.deck-area, .main-play-area, .hand-area {
  position: relative; /* å­è¦ç´ ã®çµ¶å¯¾é…ç½®ã®ãŸã‚ */
}
    
    
    
    
  </style>
</head>
<body>
  <h1>
    ç”»åƒã§éŠã¹ã‚‹ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ã‚²ãƒ¼ãƒ ï¼ˆ4äººç”¨ï¼‰
    <span id="session-indicator">ROOM: - / PLAYER: -</span>
  </h1>

  <div id="lobby" aria-modal="true" role="dialog">
    <div class="lobby-card">
      <div class="lobby-title">ãƒ—ãƒ¬ã‚¤ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã‚ˆã†ã“ã</div>
      <div class="lobby-grid">
        <section class="lobby-section">
          <label class="lobby-label">å‚åŠ ã™ã‚‹ãƒ«ãƒ¼ãƒ ID</label>
          <div class="row" style="margin-bottom:8px;">
            <input id="join-room-id" type="text" class="field" placeholder="ä¾‹: room-alpha / 1234" />
            <button id="join-room-load" class="btn secondary">èª­ã¿è¾¼ã¿</button>
          </div>

          <label class="lobby-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å / è‰²</label>
          <div class="row" style="margin-bottom:8px;">
            <input id="player-name" type="text" class="field" maxlength="24" placeholder="åå‰ï¼ˆä¾‹: Aliceï¼‰" />
            <input id="player-color" type="color" value="#22aaff" title="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ©ãƒ¼" />
          </div>

          <label class="lobby-label">åº§å¸­ã‚’é¸æŠ</label>
          <div class="seat-grid">
            <button class="seat-btn" data-seat="1">P1 <span class="seat-note"></span></button>
            <button class="seat-btn" data-seat="2">P2 <span class="seat-note"></span></button>
            <button class="seat-btn" data-seat="3">P3 <span class="seat-note"></span></button>
            <button class="seat-btn" data-seat="4">P4 <span class="seat-note"></span></button>
          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-end; gap:8px;">
            <button id="start-btn" class="btn" disabled>é–‹å§‹</button>
            <button id="clear-btn" class="btn secondary">ã‚¯ãƒªã‚¢</button>
          </div>
        </section>

        <section class="lobby-section">
          <label class="lobby-label">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</label>
          <div class="row" style="margin-bottom:8px;">
            <input id="new-room-id" type="text" class="field" placeholder="ä½œæˆã™ã‚‹IDï¼ˆä¾‹: room-xyzï¼‰" />
          </div>
          <div class="row" style="margin-bottom:12px;">
            <input id="new-room-title" type="text" class="field" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰" />
            <button id="create-room-btn" class="btn">ä½œæˆ</button>
          </div>

          <label class="lobby-label">å…¬é–‹ãƒ«ãƒ¼ãƒ ä¸€è¦§ï¼ˆæ–°ã—ã„é †ï¼‰</label>
          <div id="room-list" class="room-list"></div>
        </section>
      </div>
    </div>
  </div>

  <div id="upload-area">
    ğŸ“¥ ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ or ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§è¿½åŠ 
    <input type="file" id="file-input" multiple accept="image/*" />
  </div>

  <div id="sidebar">
    <h2>æ“ä½œãƒ‘ãƒãƒ«</h2>
    <button onclick="faceDownAll()">ğŸ‚  è£è¿”ã™ï¼ˆè‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã®ã¿ï¼‰</button>
    <button onclick="faceUpAll()">ğŸ‚¡ è¡¨ã«ã™ã‚‹ï¼ˆè‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã®ã¿ï¼‰</button>
    <button onclick="shuffleDecks()">ğŸŒ€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆè¡¨ç¤ºã®ã¿ï¼‰</button>
    <button onclick="alignDecks()">ğŸ“ æ•´åˆ—ï¼ˆè¡¨ç¤ºã®ã¿ï¼‰</button>

    <button onclick="toggleFieldSizeOptions()">ğŸ–¼ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´</button>
    <div id="field-size-options">
      <button onclick="setFieldSize('small')">å°</button>
      <button onclick="setFieldSize('medium')">ä¸­</button>
      <button onclick="setFieldSize('large')">å¤§</button>
    </div>
  </div>

  <div id="container">
    <div id="field">
    
      <div class="player-area player-1">
        <div class="player-label">
          <span class="label-seat">P1</span> <span class="label-name"></span>
        </div>
      <div class="play-area">
        <div class="deck-area">
          <div class="zone-label">ãƒ‡ãƒƒã‚­ã‚¨ãƒªã‚¢</div>
        </div>
      <div class="main-play-area">
        <div class="zone-label">ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢</div>
      </div>
    </div>
      <div class="hand-area">
        <div class="zone-label">æ‰‹æœ­ã‚¨ãƒªã‚¢</div>
      </div>
    </div>

      <div class="player-area player-2">
        <div class="player-label">
          <span class="label-seat">P2</span> <span class="label-name"></span>
        </div>
      <div class="play-area">
        <div class="deck-area">
          <div class="zone-label">ãƒ‡ãƒƒã‚­ã‚¨ãƒªã‚¢</div>
        </div>
      <div class="main-play-area">
        <div class="zone-label">ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢</div>
      </div>
    </div>
      <div class="hand-area">
        <div class="zone-label">æ‰‹æœ­ã‚¨ãƒªã‚¢</div>
      </div>
    </div>
    
      <div class="player-area player-3">
        <div class="player-label">
          <span class="label-seat">P3</span> <span class="label-name"></span>
        </div>
      <div class="play-area">
        <div class="deck-area">
          <div class="zone-label">ãƒ‡ãƒƒã‚­ã‚¨ãƒªã‚¢</div>
        </div>
      <div class="main-play-area">
        <div class="zone-label">ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢</div>
      </div>
    </div>
      <div class="hand-area">
        <div class="zone-label">æ‰‹æœ­ã‚¨ãƒªã‚¢</div>
      </div>
    </div>
    
      <div class="player-area player-4">
        <div class="player-label">
          <span class="label-seat">P4</span> <span class="label-name"></span>
        </div>
      <div class="play-area">
        <div class="deck-area">
          <div class="zone-label">ãƒ‡ãƒƒã‚­ã‚¨ãƒªã‚¢</div>
        </div>
      <div class="main-play-area">
        <div class="zone-label">ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢</div>
      </div>
    </div>
      <div class="hand-area">
        <div class="zone-label">æ‰‹æœ­ã‚¨ãƒªã‚¢</div>
      </div>
    </div>    
  </div>
</div>
  <div id="preview">
    <h2>é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰</h2>
    <img id="preview-img" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ" />
    <div id="preview-info"></div>
  </div>
  
  <div id="spacer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, runTransaction, deleteDoc, collection, query, orderBy, limit, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // â˜…ã‚ãªãŸã® Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã«å·®ã—æ›¿ãˆæ¸ˆã¿
    const firebaseConfig = {
      apiKey: "AIzaSyCy-r6L1NgyHcqvsfpkyNPDJq9uMvv2CMM",
      authDomain: "cardgame-f484c.firebaseapp.com",
      projectId: "cardgame-f484c",
      storageBucket: "cardgame-f484c.firebasestorage.app",
      messagingSenderId: "248859224605",
      appId: "1:248859224605:web:1320093856bc1861c174f4"
    };
    

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const lobby = document.getElementById('lobby');
    const joinRoomInput = document.getElementById('join-room-id');
    const joinRoomLoadBtn = document.getElementById('join-room-load');
    const playerNameInput = document.getElementById('player-name');
    const playerColorInput = document.getElementById('player-color');
    const seatButtons = Array.from(document.querySelectorAll('.seat-btn'));
    const startBtn = document.getElementById('start-btn');
    const clearBtn = document.getElementById('clear-btn');
    const sessionIndicator = document.getElementById('session-indicator');

    const newRoomIdInput = document.getElementById('new-room-id');
    const newRoomTitleInput = document.getElementById('new-room-title');
    const createRoomBtn = document.getElementById('create-room-btn');
    const roomListDiv = document.getElementById('room-list');

    let CURRENT_ROOM = null;
    let CURRENT_PLAYER = null; // 1..4
    let CURRENT_UID = null;

    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user) => { if(user){ CURRENT_UID = user.uid; }});


// ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºï¼ˆCSSã¨åˆã‚ã›ã‚‹ï¼‰
const CARD_W = 120;
const CARD_H = 160;

/** æŒ‡å®šå¸­ã®ãƒ‡ãƒƒã‚­ã‚¨ãƒªã‚¢ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åº§æ¨™ç³»ã§ã®å¢ƒç•Œã‚’è¿”ã™ */
function getDeckBoundsForSeat(seat){
  const deck = document.querySelector(`.player-${seat} .deck-area`);
  if(!deck) return null;

  const deckRect  = deck.getBoundingClientRect();
  const fieldRect = field.getBoundingClientRect();

  // field ã«ã‹ã‹ã£ã¦ã„ã‚‹ transform(translate+scale) ã‚’é€†å¤‰æ›ã—ã¦ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã¸
  const minX = (deckRect.left - fieldRect.left - panOffsetX) / zoom;
  const minY = (deckRect.top  - fieldRect.top  - panOffsetY) / zoom;
  const width  = deckRect.width  / zoom;
  const height = deckRect.height / zoom;

  return { minX, minY, width, height };
}

/** ãƒ‡ãƒƒã‚­å†…ã«ã‚«ãƒ¼ãƒ‰ãŒåã¾ã‚‹ãƒ©ãƒ³ãƒ€ãƒ åº§æ¨™ï¼ˆå·¦ä¸Šï¼‰ã‚’è¿”ã™ */
function randomPointInDeck(seat){
  const b = getDeckBoundsForSeat(seat);
  if(!b) return { x: Math.random()*500|0, y: Math.random()*500|0 }; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const maxX = Math.max(b.minX, b.minX + b.width  - CARD_W);
  const maxY = Math.max(b.minY, b.minY + b.height - CARD_H);
  const x = b.minX + Math.random() * (maxX - b.minX);
  const y = b.minY + Math.random() * (maxY - b.minY);
  return { x: Math.round(x), y: Math.round(y) };
}


    function subscribeRoomList(){
      const qRooms = query(collection(db, 'rooms'), orderBy('updatedAt', 'desc'), limit(50));
      onSnapshot(qRooms, snap => {
        roomListDiv.innerHTML = '';
        snap.forEach(docSnap => {
          const data = docSnap.data() || {};
          const item = document.createElement('div'); item.className = 'room-item';
          const left = document.createElement('div'); left.innerHTML = `<div class="room-id">${docSnap.id}</div><div style="font-size:12px; color:#555;">${(data.title||'ï¼ˆç„¡é¡Œï¼‰')}</div>`;
          const right = document.createElement('div');
          const btn = document.createElement('button'); btn.className = 'btn secondary'; btn.textContent = 'å‚åŠ '; btn.onclick = () => { joinRoomInput.value = docSnap.id; loadSeatStatus(); };
          right.appendChild(btn);
          item.appendChild(left); item.appendChild(right);
          roomListDiv.appendChild(item);
        });
      });
    }
    subscribeRoomList();

    createRoomBtn.addEventListener('click', async () => {
      const id = (newRoomIdInput.value||'').trim(); if(!id){ alert('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const title = (newRoomTitleInput.value||'').trim();
      try{
        await setDoc(doc(db, `rooms/${id}`), { title: title || null, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), public: true }, { merge: true });
        joinRoomInput.value = id; loadSeatStatus();
      }catch(e){ console.error(e); alert('ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    });

    let unsubscribeSeats = null;
    joinRoomLoadBtn.addEventListener('click', loadSeatStatus);
    joinRoomInput.addEventListener('change', loadSeatStatus);

    const currentSeatMap = {1:null,2:null,3:null,4:null};
    function isSeatStale(data){
      if(!data || !data.heartbeatAt) return true;
      const hb = data.heartbeatAt?.toMillis ? data.heartbeatAt.toMillis() : 0;
      return (Date.now() - hb) > 60000; // 60ç§’
    }

    function renderSeatAvailability(){
      seatButtons.forEach(btn => {
        const seat = parseInt(btn.dataset.seat, 10);
        const note = btn.querySelector('.seat-note');
        const data = currentSeatMap[seat];
        const taken = data && !isSeatStale(data) && data.claimedByUid && data.claimedByUid !== CURRENT_UID;
        const mine  = data && !isSeatStale(data) && data.claimedByUid === CURRENT_UID;
        btn.disabled = taken;
        note.textContent = taken ? (data.displayName ? `${data.displayName}` : 'ä½¿ç”¨ä¸­') : (mine ? 'ã‚ãªãŸ' : 'ç©ºå¸­');
        btn.classList.toggle('active', CURRENT_PLAYER === seat);
      });
      validateLobby();
    }

    function detachSeatsListener(){ if(unsubscribeSeats){ unsubscribeSeats(); unsubscribeSeats = null; } }

    function loadSeatStatus(){
      detachSeatsListener();
      const roomId = (joinRoomInput.value||'').trim();
      if(!roomId){ renderSeatAvailability(); return; }
      setDoc(doc(db, `rooms/${roomId}`), { updatedAt: serverTimestamp() }, { merge: true }).catch(()=>{});
      const seatDocs = [1,2,3,4].map(n => doc(db, `rooms/${roomId}/seats/${n}`));
      const unsubs = seatDocs.map((ref, idx) => onSnapshot(ref, snap => {
        currentSeatMap[idx+1] = snap.exists() ? snap.data() : null;
        renderSeatAvailability();
      }));
      unsubscribeSeats = () => unsubs.forEach(fn => fn());
    }

    function validateLobby(){
      const roomOk = !!(joinRoomInput.value||'').trim();
      const seatOk = !!CURRENT_PLAYER;
      const nameOk = (playerNameInput.value||'').trim().length <= 24;
      startBtn.disabled = !(roomOk && seatOk && nameOk);
    }

    seatButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const seat = parseInt(btn.dataset.seat, 10);
        const roomId = (joinRoomInput.value||'').trim();
        if(!roomId || !CURRENT_UID){ return; }
        const ok = await claimSeat(roomId, seat);
        if(ok){ CURRENT_PLAYER = seat; } else { CURRENT_PLAYER = null; alert(`P${seat} ã¯ä½¿ç”¨ä¸­ã§ã™ã€‚`); }
        renderSeatAvailability();
      });
    });

    clearBtn.addEventListener('click', () => {
      joinRoomInput.value = '';
      CURRENT_PLAYER = null;
      renderSeatAvailability();
      detachSeatsListener();
      joinRoomInput.focus();
    });

    startBtn.addEventListener('click', async () => {
      const room = (joinRoomInput.value||'').trim();
      if(!room || !CURRENT_PLAYER || !CURRENT_UID) return;
      const ok = await claimSeat(room, CURRENT_PLAYER);
      if(!ok){ alert('é–‹å§‹ç›´å‰ã«åº§å¸­ãŒåŸ‹ã¾ã‚Šã¾ã—ãŸ'); return; }
      startSession(room, CURRENT_PLAYER);
    });

    async function claimSeat(roomId, seat){
      const seatRef = doc(db, `rooms/${roomId}/seats/${seat}`);
      const displayName = (playerNameInput.value||'').trim();
      const color = playerColorInput.value || '#22aaff';
      try{
        const success = await runTransaction(db, async (tx) => {
          const snap = await tx.get(seatRef);
          if(!snap.exists()){
            tx.set(seatRef, { claimedByUid: CURRENT_UID, displayName, color, claimedAt: serverTimestamp(), heartbeatAt: serverTimestamp() });
            return true;
          }
          const data = snap.data();
          const stale = isSeatStale(data);
          if(!data.claimedByUid || stale || data.claimedByUid === CURRENT_UID){
            tx.set(seatRef, { claimedByUid: CURRENT_UID, displayName, color, claimedAt: serverTimestamp(), heartbeatAt: serverTimestamp() });
            return true;
          }
          return false;
        });
        return success;
      }catch(e){ console.error('claimSeat error', e); return false; }
    }

    async function releaseSeat(roomId, seat){
      try{ await deleteDoc(doc(db, `rooms/${roomId}/seats/${seat}`)); }catch(e){ console.warn('releaseSeat error', e); }
    }

    let heartbeatTimer = null;
    function startHeartbeat(roomId, seat){
      stopHeartbeat();
      heartbeatTimer = setInterval(async () => {
        try{ await setDoc(doc(db, `rooms/${roomId}/seats/${seat}`), { claimedByUid: CURRENT_UID, heartbeatAt: serverTimestamp() }, { merge: true }); }
        catch(e){ console.warn('heartbeat failed', e); }
      }, 10000);
    }
    function stopHeartbeat(){ if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer = null; } }

    /* ===================== ã‚«ãƒ¼ãƒ‰åŒæœŸï¼ˆã‚ªãƒ¼ãƒŠãƒ¼åˆ¶å¾¡ + è¤‡è£½é˜²æ­¢ï¼‰ ===================== */
    const field = document.getElementById("field");
    const previewImg = document.getElementById("preview-img");
    const previewInfo = document.getElementById("preview-info");
    const uploadArea = document.getElementById("upload-area");
    const fileInput = document.getElementById("file-input");
    const fieldSizeOptions = document.getElementById("field-size-options");

    let zoom = 1, panOffsetX = 0, panOffsetY = 0, selectedCard = null;

    const cardDomMap = new Map();
    // ãƒ­ãƒ¼ã‚«ãƒ«ç”±æ¥ã®å¤‰æ›´ã‚’çŸ­æ™‚é–“è¦šãˆã¦ã€onSnapshot ã®åæ˜ é‡è¤‡ã‚’æŠ‘æ­¢
    const localChangeMap = new Map();
    function markLocal(id){ localChangeMap.set(id, Date.now()); setTimeout(()=>localChangeMap.delete(id), 800); }
    function isLocalRecent(id){ const t = localChangeMap.get(id); return t && (Date.now() - t < 800); }

    let unsubscribeCards = null;
    let handlersBound = false; // äºŒé‡ãƒã‚¤ãƒ³ãƒ‰é˜²æ­¢

    function startSession(roomId, playerId){
      CURRENT_ROOM = roomId; CURRENT_PLAYER = playerId;
      sessionIndicator.textContent = `ROOM: ${CURRENT_ROOM} / PLAYER: P${CURRENT_PLAYER}`;
      lobby.style.display = 'none';
      startHeartbeat(roomId, playerId);
      window.addEventListener('beforeunload', () => { stopHeartbeat(); releaseSeat(roomId, playerId); });
      initializePlayField();
      subscribeCards();
    }

    function subscribeCards(){
      if(unsubscribeCards){ unsubscribeCards(); unsubscribeCards = null; }
      const qCards = collection(db, `rooms/${CURRENT_ROOM}/cards`);
      unsubscribeCards = onSnapshot(qCards, snap => {
        snap.docChanges().forEach(change => {
          const data = change.doc.data();
          const id = change.doc.id;
          if(change.type === 'removed'){
            const el = cardDomMap.get(id); if(el){ el.remove(); cardDomMap.delete(id); }
            return;
          }
          upsertCardFromRemote(id, data);
        });
      });
    }

    function upsertCardFromRemote(id, data){
      // æ—¢å­˜DOMã‚’å‚ç…§ï¼ˆMapã«ç„¡ãã¦ã‚‚DOMä¸Šã«ã‚ã‚‹å¯èƒ½æ€§ï¼‰
      let el = cardDomMap.get(id) || document.querySelector(`[data-card-id="${id}"]`);
      const exists = !!el;

      // ç›´è¿‘ãƒ­ãƒ¼ã‚«ãƒ«ä½œæˆ/æ›´æ–°ã®ã‚‚ã®ã¯ã€æ–°è¦DOMã‚’ä½œã‚‰ãšï¼ˆçŠ¶æ…‹é©ç”¨ã®ã¿ï¼‰
      if (!exists && !isLocalRecent(id)) {
        el = createCardDom(id, data.imageUrl, data);
        cardDomMap.set(id, el);
        field.appendChild(el);
      }
      if (el) applyCardState(el, data);
    }

    // createCardDom å†…ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿®æ­£
    function createCardDom(cardId, imageSrc, state){
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.cardId = cardId;
      card.dataset.ownerUid = state?.ownerUid || '';
      card.dataset.ownerSeat = state?.ownerSeat ? String(state.ownerSeat) : '';
      
      // è¦‹ãŸç›®ãƒ’ãƒ³ãƒˆï¼šåº§å¸­ãŒè‡ªåˆ†ã¨é•ã†ãªã‚‰ other
      card.setAttribute('data-owner',
      (card.dataset.ownerSeat && card.dataset.ownerSeat !== String(CURRENT_PLAYER)) ? 'other' : 'me'
      );
      
      const img = document.createElement("img");
      img.src = imageSrc; card.appendChild(img);

      makeDraggable(card);

      card.addEventListener("contextmenu", async e => {
        e.preventDefault();
        if (card.dataset.ownerSeat !== String(CURRENT_PLAYER)) return; // â˜…åº§å¸­ä¸€è‡´ã®ã¿OK
        const faceUp = !(card.dataset.faceUp === 'true');
        await updateCard(cardId, { faceUp, updatedAt: serverTimestamp() });
      });

card.addEventListener("click", e => {
  e.stopPropagation();
  if (selectedCard) selectedCard.classList.remove("selected");
  card.classList.add("selected");
  selectedCard = card;

  const imgEl = card.querySelector('img');
  if (imgEl && imgEl.style.display !== "none") {
    previewImg.src = imgEl.src;
    previewImg.style.display = "block";
  } else {
    previewImg.src = "";
    previewImg.style.display = "none";
  }

  // â˜… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±ï¼šã‚ªãƒ¼ãƒŠãƒ¼åº§å¸­ & è‡ªåˆ†ã®åº§å¸­
  let ownerPlayerNum = "?";
  if (card.dataset.ownerSeat) ownerPlayerNum = `P${card.dataset.ownerSeat}`;
  previewInfo.textContent = `ã‚«ãƒ¼ãƒ‰ã®ã‚ªãƒ¼ãƒŠãƒ¼: ${ownerPlayerNum} / ã‚ãªãŸ: P${CURRENT_PLAYER || "?"}`;
});
      return card;
    }
    
    
    function applyCardState(card, data){

      card.dataset.ownerUid = data.ownerUid || '';
      card.dataset.ownerSeat = (data.ownerSeat!=null) ? String(data.ownerSeat) : '';
      card.setAttribute('data-owner',
        (card.dataset.ownerSeat && card.dataset.ownerSeat !== String(CURRENT_PLAYER)) ? 'other' : 'me'
      );



      card.style.left = `${data.x||0}px`;
      card.style.top  = `${data.y||0}px`;
      card.style.zIndex = data.zIndex || 1;
      card.dataset.faceUp = data.faceUp ? 'true' : 'false';
      const img = card.querySelector('img');
      if(img){
        if(data.faceUp){ img.style.display = 'block'; card.style.backgroundColor = '#fff'; }
        else { img.style.display = 'none'; card.style.backgroundColor = '#000'; }
        if(data.imageUrl && img.src !== data.imageUrl){ img.src = data.imageUrl; }
      }
    }

    async function updateCard(cardId, patch){
      if(!CURRENT_ROOM) return;
      const ref = doc(db, `rooms/${CURRENT_ROOM}/cards/${cardId}`);
      markLocal(cardId);
      try { await updateDoc(ref, patch); } catch(e){ console.error('updateCard', e); }
    }

    function bindUploadHandlers(){
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", e => { e.preventDefault(); uploadArea.style.backgroundColor = "#eef"; });
      uploadArea.addEventListener("dragleave", () => { uploadArea.style.backgroundColor = "#fff"; });
      uploadArea.addEventListener("drop", e => { e.preventDefault(); uploadArea.style.backgroundColor = "#fff"; handleFiles(e.dataTransfer.files); });
      fileInput.addEventListener("change", e => handleFiles(e.target.files));
    }

    function handleFiles(files){
      [...files].forEach(file => {
        if(!file.type.startsWith("image/")) return;
        const reader = new FileReader();
        reader.onload = async e => {
          const imageUrl = e.target.result;
          await createCardRemote({ imageUrl });
        };
        reader.readAsDataURL(file);
      });
    }

async function createCardRemote({ imageUrl }){
  if(!CURRENT_ROOM) return;

  // â˜… è‡ªåˆ†ã®å¸­ã®ãƒ‡ãƒƒã‚­ã‚¨ãƒªã‚¢å†…ã§ãƒ©ãƒ³ãƒ€ãƒ åº§æ¨™ã‚’æ±ºå®š
  const { x: baseX, y: baseY } = randomPointInDeck(CURRENT_PLAYER);

  try{
    const ref = await addDoc(collection(db, `rooms/${CURRENT_ROOM}/cards`), {
      x: baseX, y: baseY, zIndex: 1,
      faceUp: true,
      imageUrl,
      ownerUid: CURRENT_UID,
      ownerSeat: CURRENT_PLAYER,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    // ãƒ­ãƒ¼ã‚«ãƒ«å³æ™‚åæ˜ ï¼ˆé‡è¤‡é˜²æ­¢ã®ãŸã‚ markLocalï¼‰
    markLocal(ref.id);
    let el = cardDomMap.get(ref.id) || document.querySelector(`[data-card-id="${ref.id}"]`);
    if(!el){
      el = createCardDom(ref.id, imageUrl, {
        x: baseX, y: baseY, zIndex: 1, faceUp: true,
        ownerUid: CURRENT_UID, ownerSeat: CURRENT_PLAYER
      });
      cardDomMap.set(ref.id, el);
      field.appendChild(el);
    }
    applyCardState(el, {
      x: baseX, y: baseY, zIndex: 1, faceUp: true,
      imageUrl, ownerUid: CURRENT_UID, ownerSeat: CURRENT_PLAYER
    });
  }catch(e){ console.error('createCardRemote', e); }
}




    function makeDraggable(card){
      let offsetX=0, offsetY=0, isDragging=false;
      card.addEventListener("mousedown", e => {
        if(e.button!==0) return;
        if (card.dataset.ownerSeat !== String(CURRENT_PLAYER)) return; // â˜…åº§å¸­ä¸€è‡´ã®ã¿OK
        const rect = field.getBoundingClientRect();
        const mouseX = (e.clientX - rect.left - panOffsetX) / zoom;
        const mouseY = (e.clientY - rect.top - panOffsetY) / zoom;
        offsetX = mouseX - parseFloat(card.style.left||'0');
        offsetY = mouseY - parseFloat(card.style.top||'0');
        isDragging = true; card.style.cursor = "grabbing";
        const newZ = getMaxZIndex()+1; card.style.zIndex = newZ;

        const onMove = e2 => {
          if(!isDragging) return;
          const x=(e2.clientX - rect.left - panOffsetX)/zoom; const y=(e2.clientY - rect.top - panOffsetY)/zoom;
          card.style.left = `${x - offsetX}px`; card.style.top = `${y - offsetY}px`;
        };
        const onUp = async () => {
          isDragging = false; card.style.cursor = "grab";
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
          const id = card.dataset.cardId;
          const x = parseFloat(card.style.left)||0; const y = parseFloat(card.style.top)||0; const zIndex = parseInt(card.style.zIndex)||1;
          await updateCard(id, { x, y, zIndex, updatedAt: serverTimestamp() });
        };
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
    }

    function getMaxZIndex(){ let max=0; document.querySelectorAll(".card").forEach(c=>{ const z=parseInt(c.style.zIndex)||0; if(z>max) max=z; }); return max; }

    window.faceDownAll = async function(){
      for(const [id, el] of cardDomMap){
        if (el.dataset.ownerSeat !== String(CURRENT_PLAYER)) continue;
        await updateCard(id, { faceUp: false, updatedAt: serverTimestamp() });
      }
      previewImg.src = ""; previewImg.style.display = "none";
    }
    window.faceUpAll = async function(){
      for(const [id, el] of cardDomMap){
        if (el.dataset.ownerSeat !== String(CURRENT_PLAYER)) continue;
        await updateCard(id, { faceUp: true, updatedAt: serverTimestamp() });
      }
    }

    window.toggleFieldSizeOptions = function(){ fieldSizeOptions.style.display = fieldSizeOptions.style.display==="none"?"block":"none"; }
    window.setFieldSize = function(size){ const sizes={ small:[3000,1500], medium:[5000,2500], large:[10000,5000] }; const [w,h]=sizes[size]||sizes.small; field.style.width=`${w}px`; field.style.height=`${h}px`; field.style.transform=`translate(${panOffsetX}px, ${panOffsetY}px) scale(${zoom})`; }
    window.alignDecks = function(){ /* è¡¨ç¤ºã®ã¿ */ }
    window.shuffleDecks = function(){ /* è¡¨ç¤ºã®ã¿ */ }

    function bindPanZoomHandlers(){
      field.addEventListener("wheel", e => { if(e.ctrlKey) return; e.preventDefault(); const rect=field.getBoundingClientRect(); const cx=e.clientX-rect.left; const cy=e.clientY-rect.top; const scale=0.1; const old=zoom; zoom += e.deltaY<0?scale:-scale; zoom = Math.max(0.3, Math.min(zoom, 3)); const sx=(cx - panOffsetX)/old; const sy=(cy - panOffsetY)/old; panOffsetX = cx - sx*zoom; panOffsetY = cy - sy*zoom; field.style.transform=`translate(${panOffsetX}px, ${panOffsetY}px) scale(${zoom})`; }, {passive:false});
      field.addEventListener("mousedown", e => { if(e.target.closest(".card")) return; let panning=true; let sx=e.clientX, sy=e.clientY; const onMove=e2=>{ if(!panning) return; const dx=e2.clientX-sx; const dy=e2.clientY-sy; panOffsetX+=dx; panOffsetY+=dy; sx=e2.clientX; sy=e2.clientY; field.style.transform=`translate(${panOffsetX}px, ${panOffsetY}px) scale(${zoom})`; }; const onUp=()=>{ panning=false; document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onUp); }; document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onUp); });
      field.addEventListener("click", () => { if(selectedCard){ selectedCard.classList.remove("selected"); selectedCard=null; previewImg.src=""; previewImg.style.display="none"; } });
    }

    function initializePlayField(){
      setFieldSize('small');
      if (!handlersBound) {
        bindUploadHandlers();
        bindPanZoomHandlers();
        handlersBound = true;
      }
    }
  </script>
</body>
</html>
