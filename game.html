<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>プレイアラウンド - ゲーム画面</title>
  <style>
    body { margin: 0; font-family: sans-serif; overflow: hidden; }
    #upload-bar {
      height: 10vh; background: #eee; text-align: center;
      line-height: 10vh; border-bottom: 2px solid #ccc; cursor: pointer;
    }
    #main { height: 90vh; display: flex; flex-direction: row; }
    #control-panel {
      width: 20vw; background: #f5f5f5; padding: 10px;
      box-sizing: border-box; overflow-y: auto; border-right: 2px solid #ccc;
    }
    #field {
      flex: 3; background: #fff; position: relative;
      overflow: hidden; transform-origin: center center;
    }
    #selected-card {
      width: 30vw; background: #f9f9f9; border-left: 2px solid #ccc;
      display: flex; align-items: center; justify-content: center;
    }
    #selected-card img {
      max-width: 90%; max-height: 90%;
      border: 3px solid red; border-radius: 5px;
    }
    .card {
      position: absolute; width: 100px; height: 140px;
      object-fit: cover; user-select: none; cursor: grab;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebaseConfig.js"></script>
</head>
<body>
  <div id="upload-bar" onclick="document.getElementById('fileInput').click()">
    カード画像をクリック or ドラッグ＆ドロップで追加
    <input type="file" id="fileInput" style="display:none;" accept="image/*" />
  </div>
  <div id="main">
    <div id="control-panel">
      <button onclick="flipCards(true)">裏返す</button><br />
      <button onclick="flipCards(false)">表にする</button><br />
      <button onclick="shuffleCards()">シャッフル</button><br />
      <button onclick="alignCards()">整列</button><br />
      <button onclick="shiftCards(0,-50)">上にずらす</button><br />
      <button onclick="shiftCards(0,50)">下にずらす</button><br />
      <button onclick="shiftCards(-50,0)">左にずらす</button><br />
      <button onclick="shiftCards(50,0)">右にずらす</button><br />
    </div>
    <div id="field"></div>
    <div id="selected-card"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("room");
    const playerId = urlParams.get("player");

    const dbRef = db.collection("rooms").doc(roomId);

    let selectedCard = null;
    let zIndexCounter = 1;
    let localCards = {}; // ローカル追跡用

    function createCardElement(id, data, isLocal) {
      const img = document.createElement("img");
      img.src = data.faceDown && !isLocal ? "images/back.png" : data.img;
      img.className = "card";
      img.style.left = data.x + "px";
      img.style.top = data.y + "px";
      img.style.zIndex = zIndexCounter++;
      img.setAttribute("data-id", id);
      img.draggable = false;
      if (isLocal) {
        img.addEventListener("mousedown", startDrag);
        img.addEventListener("click", () => selectCard(img));
      }
      return img;
    }

    function syncCard(id, data, isLocal) {
      const existing = document.querySelector(`.card[data-id="${id}"]`);
      if (existing) {
        existing.src = data.faceDown && !isLocal ? "images/back.png" : data.img;
        existing.style.left = data.x + "px";
        existing.style.top = data.y + "px";
      } else {
        const newCard = createCardElement(id, data, isLocal);
        document.getElementById("field").appendChild(newCard);
      }
    }

    dbRef.collection("cards").onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        const id = change.doc.id;
        const data = change.doc.data();
        syncCard(id, data, data.owner === playerId);
      });
    });

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const id = "card_" + Date.now();
        const data = {
          img: event.target.result,
          x: 200,
          y: 200,
          faceDown: false,
          owner: playerId,
        };
        dbRef.collection("cards").doc(id).set(data);
      };
      reader.readAsDataURL(file);
    });

    function selectCard(card) {
      selectedCard = card;
      const viewer = document.getElementById("selected-card");
      viewer.innerHTML = "";
      const copy = card.cloneNode();
      viewer.appendChild(copy);
    }

    function flipCards(toBack) {
      dbRef.collection("cards")
        .where("owner", "==", playerId)
        .get().then(snap => {
          snap.forEach(doc => {
            doc.ref.update({ faceDown: toBack });
          });
        });
    }

    function shuffleCards() {
      const baseX = 300, baseY = 300;
      dbRef.collection("cards")
        .where("owner", "==", playerId)
        .get().then(snap => {
          let offset = 0;
          snap.forEach(doc => {
            doc.ref.update({
              x: baseX + Math.random() * 30,
              y: baseY + Math.random() * 30
            });
          });
        });
    }

    function alignCards() {
      let x = 100, y = 100;
      dbRef.collection("cards")
        .where("owner", "==", playerId)
        .get().then(snap => {
          snap.forEach(doc => {
            doc.ref.update({ x: x, y: y });
            x += 110;
          });
        });
    }

    function shiftCards(dx, dy) {
      dbRef.collection("cards")
        .where("owner", "==", playerId)
        .get().then(snap => {
          snap.forEach(doc => {
            const d = doc.data();
            doc.ref.update({
              x: d.x + dx,
              y: d.y + dy
            });
          });
        });
    }

    let dragging = null;
    function startDrag(e) {
      dragging = e.target;
      dragging.style.zIndex = zIndexCounter++;
      const id = dragging.getAttribute("data-id");
      const startX = e.clientX;
      const startY = e.clientY;
      const origX = parseInt(dragging.style.left || "0");
      const origY = parseInt(dragging.style.top || "0");

      function onMouseMove(ev) {
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        dragging.style.left = `${origX + dx}px`;
        dragging.style.top = `${origY + dy}px`;
      }

      function onMouseUp(ev) {
        window.removeEventListener("mousemove", onMouseMove);
        window.removeEventListener("mouseup", onMouseUp);
        dragging = null;
        dbRef.collection("cards").doc(id).update({
          x: parseInt(dragging.style.left),
          y: parseInt(dragging.style.top)
        });
      }

      window.addEventListener("mousemove", onMouseMove);
      window.addEventListener("mouseup", onMouseUp);
    }
  </script>
</body>
</html>
